<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<!-- Other scripts -->
<script src="../bower_components/history.js/scripts/bundled/html5/native.history.js"></script>

<link rel="import" href="theme.html">


<script>
    Polymer({
        is: 'xhr-link',
        extends: 'a',
        listeners: {
            'click': '_handleClick'
        },
        _handleClick: function(e) {
            var loader = document.querySelector('ostinato-xhr');
            if (loader) {
                e.preventDefault();
                loader.generateRequest(this.pathname);
            }
        }
    });
</script>


<dom-module id="ostinato-xhr-context">
    <!--
        Handy helper to modify the page context. This tag can be placed in
        any xhr loaded page, and once ready it will run the updates.
    -->
    <script>
        Polymer({
            is: 'ostinato-xhr-context',
            properties: {
                pageTitle: String,
                other: Object
            },

            ready: function() {
                this.updateTitle();
            },

            updateTitle: function() {
                if (this.pageTitle) document.title = this.pageTitle;
            }
        });
    </script>
</dom-module>


<dom-module id="ostinato-xhr">
    <template>
        <iron-ajax
            id="xhr"
            method="[[method]]"
            handle-as="text/html"
            headers='{"X-Requested-With": "XMLHttpRequest"}'
            content-type="[[contentType]]"
            on-response="_handleResponse"
            on-error="_handleError"></iron-ajax>
    </template>
    <script>
        Polymer({
            is: 'ostinato-xhr',

            properties: {
                targetSelector: String,

                method: {
                    type: String,
                    value: 'get'
                },

                contentType: {
                    type: String,
                    value: null
                },

                /**
                 * Whether or not to update the browser history when this
                 * component is used.
                 */
                updateHistory: {
                    type: Boolean,
                    value: false
                }
            },

            attached: function() {
                if (this.updateHistory) {
                    this.currentUrl = window.location.pathname;
                    History.Adapter.bind(window, 'statechange', function() {
                        var state = History.getState();
                        this.generateRequest(state.url);
                    }.bind(this));
                }
            },

            generateRequest: function(url, data) {
                this.debounce(url, function() {
                    if (data) { this.$.xhr.body = data; }
                    this.$.xhr.url = url;
                    this.$.xhr.generateRequest();
                });
            },

            _getContext: function(target) {
                return target.querySelector('ostinato-xhr-context');
            },

            _getTargetContent: function(html) {
                var doc = new DOMParser().parseFromString(html, "text/html");
                return doc.querySelector(this.targetSelector);
            },

            _handleResponse: function() {
                var target = document.querySelector(this.targetSelector);
                var content = this._getTargetContent(this.$.xhr.lastResponse);

                if (content) {
                    target.innerHTML = content.innerHTML;
                } else {
                    target.innerHTML = this.$.xhr.lastResponse;
                }

                // Now that the content was updated, update the history also
                if (this.updateHistory) {
                    var context, data = null, title = null;

                    if (content) {
                        context = this._getContext(content);
                        if (context) { title = context.pageTitle; }
                    }
                    History.pushState(data, title, this.$.xhr.url);
                }
            },

            _handleError: function() {
                console.log('TODO: Handle error response');
            }
        });
    </script>
</dom-module>


<dom-module id="ostinato-xhr-form">
    <script>
        Polymer({
            /**
             * This element will extend the form so that it will submit via
             * ajax. This is a full ostinato-xhr post, so the expected response
             * should be html.
             *
             * Normal submit buttons in the form will still submit it
             * normally. If you want to have it submitted via ajax, you need
             * to include a element with the [confirm] attribute.
             *
             * A [cancel] element can be specified in the same way.
             *
             */
            is: 'ostinato-xhr-form',
            extends: 'form',

            properties: {
                /**
                 * The target selector for the container to replace the form
                 * content with the response.
                 */
                targetSelector: String,
            },

            attached: function() {
                this.xhr = document.createElement('ostinato-xhr');
                this.xhr.contentType = "application/x-www-form-urlencoded";
                this.xhr.method = this.method;
                this.xhr.targetSelector = this.targetSelector;
                this.xhr.url = this.action;

                this.confirm = Polymer.dom(this).querySelector('[confirm]');
                this.cancel = Polymer.dom(this).querySelector('[cancel]');

                this.confirm.addEventListener('click', function() {
                    var json = this.serialize();
                    this.xhr.generateRequest(this.action, json);
                }.bind(this));
            },

            serialize: function() {
                var json = {};
                for (var i=0; i < this.elements.length; i++) {
                    json[this.elements[i].name] = this.elements[i].value;
                }
                return json;
            }
        });
    </script>
</dom-module>


<dom-module id="ostinato-app">
    <script>
        Polymer({
            is: 'ostinato-app',
        });
    </script>
</dom-module>
