<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<!-- Other scripts -->
<script src="../bower_components/history.js/scripts/bundled/html5/native.history.js"></script>

<link rel="import" href="theme.html">


<script>
    Polymer({
        is: 'xhr-link',
        extends: 'a',
        listeners: {
            'click': '_handleClick'
        },
        _handleClick: function(e) {
            var loader = document.querySelector('ostinato-xhr');
            if (loader) {
                e.preventDefault();
                loader.loadContent(this.pathname);
            }
        }
    });
</script>


<dom-module id="ostinato-xhr-context">
    <!--
        Handy helper to modify the page context. This tag can be placed in
        any xhr loaded page, and once ready it will run the updates.
    -->
    <script>
        Polymer({
            is: 'ostinato-xhr-context',
            properties: {
                pageTitle: String,
                other: Object
            },

            ready: function() {
                this.updateTitle();
            },

            getData: function() {
                return {
                    pageTitle: this.pageTitle,
                    other: this.other
                }
            },

            updateTitle: function() {
                if (this.pageTitle) document.title = this.pageTitle;
            }
        });
    </script>
</dom-module>


<dom-module id="ostinato-xhr">
    <template>
        <iron-ajax
            id="xhr"
            method="get"
            handle-as="text/html"
            headers='{"X-Requested-With": "XMLHttpRequest"}'
            on-response="_handleResponse"
            on-error="_handleError"></iron-ajax>
    </template>
    <script>
        Polymer({
            is: 'ostinato-xhr',

            properties: {
                targetSelector: String,

                /**
                 * Whether or not to update the browser history when this
                 * component is used.
                 */
                updateHistory: {
                    type: Boolean,
                    value: false
                }
            },

            attached: function() {
                if (this.updateHistory) {
                    this.currentUrl = window.location.pathname;
                    History.Adapter.bind(window, 'statechange', function() {
                        var state = History.getState();
                        // Here we can take extra actions if required.
                    }.bind(this));
                }
            },

            loadContent: function(url) {
                this.debounce(url, function() {
                    this.$.xhr.url = url;
                    this.$.xhr.generateRequest();
                });
            },

            _getContext: function(target) {
                return target.querySelector('ostinato-xhr-context');
            },

            _getTargetContent: function(html) {
                var doc = new DOMParser().parseFromString(html, "text/html");
                return doc.querySelector('#content');
            },

            _handleResponse: function() {
                var target = document.querySelector(this.targetSelector);
                var content = this._getTargetContent(this.$.xhr.lastResponse);

                if (content) {
                    target.innerHTML = content.innerHTML;
                } else {
                    target.innerHTML = this.$.xhr.lastResponse;
                }

                // Now that the content was updated, update the history also
                if (this.updateHistory && content) {
                    var context = this._getContext(content),
                        data = null,
                        title = null;

                    if (context) {
                        title = context.pageTitle;
                        data = context.getData();
                    }
                    History.pushState(data, title, this.$.xhr.url);
                }
            },

            _handleError: function() {
                console.log('TODO: Handle error response');
            }
        });
    </script>
</dom-module>


<dom-module id="ostinato-app">
    <script>
        Polymer({
            is: 'ostinato-app',
        });
    </script>
</dom-module>
