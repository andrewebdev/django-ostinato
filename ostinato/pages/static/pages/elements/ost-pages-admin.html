<!-- Import dependencies -->
<!--
    TODO: Find a way to have this static/ostinato import path as a setting
    so that we don't need to hard-code the location.
-->
<link rel="import" href="/static/ostinato/bower_components/polymer/polymer.html">
<link rel="import" href="/static/ostinato/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/static/ostinato/bower_components/iron-signals/iron-signals.html">
<link rel="import" href="/static/ostinato/bower_components/paper-icon-button/paper-icon-button.html">


<dom-module id="ost-pages-controller">
    <template>
        <form id="actionForm" action="{{_action}}" method="post" accept-charset="utf-8">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{csrfToken}}"/>
            <input type="hidden" name="node" value="{{node}}"/>
            <input type="hidden" name="target" value="{{target}}"/>
            <input type="hidden" name="position" value="{{position}}"/>
        </form>
    </template>
</dom-module>
<script>
    (function() {
        'use strict';

        Polymer({
            is: 'ost-pages-controller',

            properties: {
                pageAddUrl: String,
                moveAction: String,
                copyAction: String,
                csrfToken: String,

                node: Number,
                target: Number,
                position: Number,
            },

            ready: function() {
                this.reset();
            },

            reset: function() {
                this.node = null;
                this._action = "";
                this.fire('iron-signal', {
                    name: 'page-action',
                    data: {action: 'cancel', node: null}
                });
            },

            startAction: function(action, node) {
                this.node = node;
                if (action == 'move') {
                    this._action = this.moveAction;
                } else if (action == 'copy') {
                    this._action = this.copyAction;
                }
                this.fire('iron-signal', {
                    name: 'page-action',
                    data: {action: action, node: node}
                });
            },

            commitAction: function(target, position) {
                if (this.node && this._action) {
                    var nodeEl = document.querySelector('ost-page-node[node-id="' + this.node + '"]');
                    var targetEl = document.querySelector('ost-page-node[node-id="' + target + '"]');

                    // Node cannot be made descendant of one of it's descendants
                    if (targetEl.isDescendentOf(nodeEl)) {
                        alert("Page cannot be made a child or sibling of one of it's descendants");
                        return;
                    } else {
                        this.target = target;
                        this.position = position;
                        this.$.actionForm.submit();
                    }
                }
            }

        });

    })();
</script>


<dom-module id="ost-pages-actions">
    <style>
        :host {
            @apply(--layout-horizontal);
            @apply(--layout-center-justified);
        }
        paper-icon-button { width: 35px; }
    </style>
    <template>
        <iron-signals on-iron-signal-page-action="_handleControllerAction"></iron-signals>

        <template is="dom-if" if="{{!_actionNode}}">
            <paper-icon-button title="move page"
                            icon="open-with"
                            on-click="_handleMove"></paper-icon-button>

            <paper-icon-button title="create copy"
                            icon="content-copy"
                            on-click="_handleCopy"></paper-icon-button>

            <paper-icon-button title="create child-page"
                            icon="add-box"
                            on-click="_handleAddChild"></paper-icon-button>
        </template>

        <template is="dom-if" if="{{showCancel(nodeId,_actionNode)}}">
            <paper-icon-button title="cancel"
                            icon="cancel"
                            on-click="_handleCancel"></paper-icon-button>
        </template>

        <template is="dom-if" if="{{showTargets(nodeId,_actionNode)}}">
            <paper-icon-button title="above this page"
                            icon="arrow-upward"
                            on-click="_handleMoveAbove"></paper-icon-button>

            <paper-icon-button title="below this page"
                            icon="arrow-downward"
                            on-click="_handleMoveBelow"></paper-icon-button>

            <paper-icon-button title="as child page"
                            icon="subdirectory-arrow-right"
                            on-click="_handleMoveChild"></paper-icon-button>
        </template>

    </template>
</dom-module>
<script>
    (function() {
        'use strict';

        Polymer({
            is: 'ost-pages-actions',
            properties: {
                nodeId: Number
            },

            ready: function() {
                // Get the ost-pages-action-controller
                this._pagesController = document.querySelector('ost-pages-controller');
                this._actionNode = null;
            },

            showCancel: function(nodeId, actionNode) {
                return nodeId == actionNode;
            },

            showTargets: function(targetNodeId, actionNodeId) {
                // TODO: Node cannot be child of one of it's descendants
                return actionNodeId && actionNodeId != targetNodeId;
            },

            _handleControllerAction: function(ev, data) {
                if (data.action == 'cancel') {
                    this._actionNode = null;
                } else {
                    this._actionNode = data.node;
                }
            },

            _handleAddChild: function() {
                var baseUrl = this._pagesController.pageAddUrl; 
                window.location = baseUrl + "?parent=" + this.nodeId;
            },

            _handleMove: function() {
                this._pagesController.startAction('move', this.nodeId);
            },

            _handleCopy: function() {
                this._pagesController.startAction('copy', this.nodeId);
            },

            _handleMoveAbove: function() {
                this._pagesController.commitAction(this.nodeId, 'left');
            },

            _handleMoveBelow: function() {
                this._pagesController.commitAction(this.nodeId, 'right');
            },

            _handleMoveChild: function() {
                this._pagesController.commitAction(this.nodeId, 'last-child');
            },

            _handleCancel: function() {
                this._pagesController.reset();
            }
        });
    })();
</script>


<dom-module id="ost-page-node">
    <style>
        :host {
            display: inline-block;
            width: 35px;
        }
        paper-icon-button {
            width: 35px;
            height: 35px;
        }
        iron-icon {
            width: 35px;
            height: 15px;
        }
    </style>
    <template>
        <template is="dom-if" if="{{descendants}}">
            <paper-icon-button icon="{{icon}}" on-click="_handleToggleClick"></paper-icon-button>
        </template>
    </template>
</dom-module>
<script>
    (function() {
        'use strict';

        Polymer({
            is: 'ost-page-node',
            properties: {
                nodeId: Number,
                treeId: Number,
                level: Number,
                lft: Number,
                rght: Number,
                descendants: {
                    type: Boolean,
                    value: false
                },
                open: {
                    type: Boolean,
                    value: true
                }
            },

            attached: function() {
                this.style = "padding-left: " + (this.level * 20) + "px;";
                this._updateIcon();
            },

            _handleToggleClick: function(ev) {
                ev.preventDefault();
                this._toggleDescendants();
            },

            _updateIcon: function() {
                if (this.descendants) {
                    if (this.open) this.icon = 'expand-more';
                    else this.icon = 'chevron-right';
                } else {
                    this.icon = '';
                }
            },

            isDescendentOf: function(node) {
                return ((this.lft > node.lft) && (this.rght < node.rght));
            },

            hide: function() {
                this.parentNode.parentNode.parentNode.style = "display: none";
                this._updateIcon();
            },

            show: function() {
                this.parentNode.parentNode.parentNode.style = "display: row;";
                this._updateIcon();
            },

            _toggleDescendants: function() {
                var treeNodes = document.querySelectorAll('ost-page-node[tree-id="' + this.treeId + '"]');

                // Update our node state
                this.open = !this.open;
                this._updateIcon();

                // Now update the descenants
                for (var i=0; i < treeNodes.length; i++) {
                    var node = treeNodes[i];
                    var is_descendant = ((node.lft > this.lft) && (node.rght < this.rght));
                    if (is_descendant) {
                        if (this.open) {
                            // When showing, only show immediate descendants
                            if (node.level == this.level + 1) {
                                node.open = false;
                                node.show();
                            }
                        } else {
                            // All descendants should be collapsed
                            node.hide();
                        }
                    }
                }
            }
        });

    })();
</script>


<dom-module id="ost-page-detail-controller">
    <style>
    </style>
    <template>
    </template>
</dom-module>
<script>
    (function() {
        'use strict';

        Polymer({
            is: 'ost-page-detail-controller'
        });

    })();
</script>

